<!DOCTYPE html>
<html lang="en" ng-app="northwindApp">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Orders Information - Northwind App</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />

    <!-- Kendo UI CSS -->
    <link rel="stylesheet" href="https://kendo.cdn.telerik.com/2023.1.117/styles/kendo.common.min.css" />
    <link rel="stylesheet" href="https://kendo.cdn.telerik.com/2023.1.117/styles/kendo.bootstrap-v4.min.css" />

    <style>
        body { padding-top: 20px; }
        .customer-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .k-grid { margin-top: 15px; }
        .loading-spinner {
            display: flex;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>
<body ng-controller="CustomerOrdersController">
    <div class="container">
        <!-- Breadcrumb -->
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="index.html">Customers By Country</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">Customer Orders</li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <h2>Customer Orders Information</h2>
                <hr />
            </div>
        </div>

        <!-- Customer Info Card -->
        <div class="row" ng-show="customer">
            <div class="col-12">
                <div class="customer-info">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Customer ID:</strong> {{customer.customerId}}</p>
                            <p><strong>Company Name:</strong> {{customer.companyName}}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Contact Name:</strong> {{customer.contactName}}</p>
                            <p><strong>Country:</strong> {{customer.country}}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div class="row" ng-show="isLoading">
            <div class="col-12 loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Error message -->
        <div class="row" ng-show="errorMessage">
            <div class="col-12">
                <div class="alert alert-danger">
                    {{errorMessage}}
                </div>
            </div>
        </div>

        <!-- No orders message -->
        <div class="row" ng-show="!isLoading && !errorMessage && orders.length === 0 && customer">
            <div class="col-12">
                <div class="alert alert-info">
                    No orders found for customer: <strong>{{customer.companyName}}</strong>
                </div>
            </div>
        </div>

        <!-- Kendo Grid for Orders -->
        <div class="row" ng-show="orders.length > 0">
            <div class="col-12">
                <h4>Orders (sorted by Shipped Date)</h4>
                <div id="ordersGrid"></div>
            </div>
        </div>

        <!-- Back Button -->
        <div class="row mt-4">
            <div class="col-12">
                <a href="index.html" class="btn btn-secondary">
                    &larr; Back to Customers
                </a>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- jQuery (required for Kendo UI) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- AngularJS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>

    <!-- Kendo UI -->
    <script src="https://kendo.cdn.telerik.com/2023.1.117/js/kendo.all.min.js"></script>

    <script>
        // AngularJS Application
        var app = angular.module('northwindApp', []);

        // API Configuration
        var API_BASE_URL = 'http://localhost:5001/api';

        // Utility function to get URL parameter
        function getQueryParam(name) {
            var urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // CustomerOrders Controller
        app.controller('CustomerOrdersController', ['$scope', '$http', function($scope, $http) {
            // Initialize scope variables
            $scope.customer = null;
            $scope.orders = [];
            $scope.isLoading = false;
            $scope.errorMessage = '';

            // Get customer ID from URL
            var customerId = getQueryParam('customerId');

            if (!customerId) {
                $scope.errorMessage = 'No customer ID provided. Please go back and select a customer.';
                return;
            }

            // Load customer and orders
            $scope.isLoading = true;

            // First, get customer information
            $http.get(API_BASE_URL + '/customers/' + encodeURIComponent(customerId))
                .then(function(response) {
                    $scope.customer = response.data;
                    return loadOrders(customerId);
                })
                .catch(function(error) {
                    $scope.errorMessage = 'Customer not found: ' + customerId;
                    $scope.isLoading = false;
                });

            // Load orders using Kendo DataSource
            function loadOrders(customerId) {
                var dataSource = new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: API_BASE_URL + '/orders/customer/' + encodeURIComponent(customerId),
                            dataType: 'json'
                        }
                    },
                    schema: {
                        model: {
                            id: 'orderId',
                            fields: {
                                orderId: { type: 'number' },
                                customerId: { type: 'string' },
                                orderDate: { type: 'date' },
                                shippedDate: { type: 'date' }
                            }
                        }
                    },
                    sort: { field: 'shippedDate', dir: 'asc' },
                    requestEnd: function(e) {
                        $scope.$apply(function() {
                            $scope.orders = e.response || [];
                            $scope.isLoading = false;
                        });
                    },
                    error: function(e) {
                        $scope.$apply(function() {
                            $scope.isLoading = false;
                            $scope.errorMessage = 'Error loading orders. Please try again.';
                        });
                    }
                });

                // Initialize Kendo Grid
                $('#ordersGrid').kendoGrid({
                    dataSource: dataSource,
                    sortable: true,
                    pageable: {
                        pageSize: 10,
                        pageSizes: [5, 10, 20, 50]
                    },
                    filterable: true,
                    columns: [
                        {
                            field: 'orderId',
                            title: 'Order ID',
                            width: '100px'
                        },
                        {
                            field: 'customerId',
                            title: 'Customer ID',
                            width: '120px'
                        },
                        {
                            field: 'orderDate',
                            title: 'Order Date',
                            width: '150px',
                            format: '{0:yyyy-MM-dd}',
                            template: function(dataItem) {
                                if (dataItem.orderDate) {
                                    return kendo.toString(new Date(dataItem.orderDate), 'yyyy-MM-dd');
                                }
                                return 'N/A';
                            }
                        },
                        {
                            field: 'shippedDate',
                            title: 'Shipped Date',
                            width: '150px',
                            format: '{0:yyyy-MM-dd}',
                            template: function(dataItem) {
                                if (dataItem.shippedDate) {
                                    return kendo.toString(new Date(dataItem.shippedDate), 'yyyy-MM-dd');
                                }
                                return 'Not Shipped';
                            }
                        }
                    ]
                });

                dataSource.read();
            }
        }]);
    </script>
</body>
</html>
